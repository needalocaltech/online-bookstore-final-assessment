<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout – BookStore</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>

<header>
    <div class="navbar">
        <div class="logo">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="BookStore Logo" />
        </div>
        <nav>
            <ul>
                <li><a href="{{ url_for('index') }}">Home</a></li>
                <li><a href="{{ url_for('view_cart') }}">Cart</a></li>
                {% if current_user %}
                    <li><a href="{{ url_for('my_orders') }}">My Orders</a></li>
                    <li><a href="{{ url_for('logout') }}">Logout ({{ current_user.name }})</a></li>
                {% else %}
                    <li><a href="{{ url_for('login') }}">Login</a></li>
                {% endif %}
            </ul>
        </nav>
    </div>
</header>

<main class="checkout-container">

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="flash {{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <h2>Checkout</h2>

    <section class="order-summary">
        <h3>Your Order</h3>
        {% if cart and not cart.is_empty() %}
            <ul class="order-items">
                {% for item in cart.items %}
                    <li>
                        <span class="title">{{ item.title }}</span>
                        <span class="qty">x {{ item.quantity }}</span>
                        <span class="price">£{{ "%.2f"|format(item.price) }}</span>
                    </li>
                {% endfor %}
            </ul>
            <p class="order-total">
                <strong>Total:</strong>
                £{{ "%.2f"|format(cart.get_total_price()) }}
            </p>
        {% else %}
            <p>Your cart is empty.</p>
        {% endif %}
    </section>

    <!-- IMPORTANT: POST + CSRF token -->
    <form action="{{ url_for('process_checkout') }}" method="POST" class="checkout-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <fieldset>
            <legend>Shipping Information</legend>
            <div class="form-group">
                <label for="name">Full Name</label>
                <input
                    type="text"
                    id="name"
                    name="name"
                    required
                    value="{{ current_user.name if current_user else '' }}"
                >
            </div>

            <div class="form-group">
                <label for="email">Email</label>
                <input
                    type="email"
                    id="email"
                    name="email"
                    required
                    value="{{ current_user.email if current_user else '' }}"
                >
            </div>

            <div class="form-group">
                <label for="address">Address</label>
                <input
                    type="text"
                    id="address"
                    name="address"
                    required
                >
            </div>

            <div class="form-group">
                <label for="city">City</label>
                <input
                    type="text"
                    id="city"
                    name="city"
                    required
                >
            </div>

            <div class="form-group">
                <label for="zip_code">Postcode</label>
                <input
                    type="text"
                    id="zip_code"
                    name="zip_code"
                    required
                >
            </div>
        </fieldset>

        <fieldset>
            <legend>Payment Details (Demo Only)</legend>
            <div class="form-group">
                <label for="card_number">Card Number</label>
                <input
                    type="text"
                    id="card_number"
                    name="card_number"
                    required
                    placeholder="1111 2222 3333 4444"
                >
            </div>

            <div class="form-group">
                <label for="expiry_date">Expiry Date</label>
                <input
                    type="text"
                    id="expiry_date"
                    name="expiry_date"
                    required
                    placeholder="MM/YY"
                >
            </div>

            <div class="form-group">
                <label for="cvv">CVV</label>
                <input
                    type="text"
                    id="cvv"
                    name="cvv"
                    required
                    placeholder="123"
                >
            </div>
        </fieldset>

        <button type="submit" class="btn btn-primary">Place Order</button>
    </form>

</main>

<footer>
    <p>&copy; {{ current_year }} BookStore. All rights reserved.</p>
</footer>

</body>
</html>
